## 一、实验介绍

本节实验主要介绍如何将我们的OS运行在K210开发板中，并通过串口与之交互。

## 二、实验目的

1. 认识学习将OS运行上板的流程
2. 认识OS分别在QEMU与真实板卡上运行的区别点

## 三、实验要求

1. 成功将OS在K210板卡中运行

## 四、实验步骤

### 1. 内核构建

在实验一中我们知道，构建系统通过`platform`参数来指定当前编译的OS所运行的平台，其值可以为`qemu`或`k210`。

对于QEMU而言，我们只需要通过将QEMU启动选项中的bootloader以及kernel参数分别指定为**ELF**格式的SBI（请参考实验二中关于SBI的介绍）与OS内核，即可完成系统的启动引导。

![QEMU参数指定](https://hdu-tmp.oss-cn-hangzhou.aliyuncs.com/images/uploads/2023-06-11/RHFZSt2OCd.png)



但是在K210板卡中，很难做到像QEMU那样通过参数“告诉”硬件相关信息，更不能让它直接识别**ELF**这类文件格式了，因此，要将OS载入至板卡运行，我们必须直接提供内核的二进制版本（binary），也就是在嵌入式开发领域常见的`.bin`文件。要将**ELF**转化为**BIN**，我们需要借助`objcopy`工具的协助，这一部分已经在`Makefile`构建脚本中被自动化进行了，要生成OS的二进制格式文件，我们只需要在命令行输入构建指令：`make`，即可完成操作系统二进制程序的构建。

```shell
all: kernel
    $(OBJCOPY) $(BUILD_ROOT)/kernel -S -O binary $(BUILD_ROOT)/kernel.bin
    $(OBJCOPY) bootloader/sbi-k210 -S -O binary $(BUILD_ROOT)/os.bin
    dd if=$(BUILD_ROOT)/kernel.bin of=$(BUILD_ROOT)/os.bin bs=128k seek=1
```

这个脚本通过调用`objcopy`工具来将ELF格式的内核与SBI进一步转化为BIN文件，再将两者进行拼接，从而形成最终的`os.bin`文件，你可以在`build`目录下找到这个文件。

### 2. 文件系统构建

操作系统需要从外部文件系统中加载程序执行、读写外部文件，因此除了操作系统本身的构建以外，我们还需要为它构建可以读写的文件系统镜像，该镜像最终将会被烧录至SD卡中，在K210上通过SPI通信协议与之读写交互。

要生成用户文件镜像，只需要输入指令：`make fs.img`，该指令会自动构建`user/src`下的所有c文件，并与`user/raw`下的文件一起，被拷贝进文件镜像的根目录中，最终镜像的文件内容你可以在`build/user_prog`中查看，至于文件镜像本身则被生成为`build/fs.img`。

### 3. 烧录

在vscode中，你可以右键文件，通过`Upload`或者`Download`选项，来上传或者下载文件。将上面两个步骤生成的`os.bin`系统固件以及`fs.img`文件镜像分别下载至本地，以便后续的烧录操作。

对于文件镜像的烧录而言，我们可以通过rufus烧录软件来对SD卡进行烧录，过程如下：

1. 将SD卡从K210上卸下，插入读卡器，再将读卡器连接至电脑
2. 打开rufus，选中SD卡（通常为小容量128G）
3. 点击`选择`按钮，选择事先下载下来的`fs.img`镜像
4. 点击`开始`进行烧录，最后卸下读卡器，将SD卡插回K210

对于固件的烧录，我们通过kflash软件进行烧录，这里只介绍Kflash_GUI的操作步骤：

1. 将K210通过串口连接至电脑，并安装CH340驱动程序
2. 打开Kflash_GUI软件，点击`打开文件`，选择事先下载的`os.bin`文件
3. 选择`开发板`为`Sipeed Maix Dock`
4. 选择`端口`为合适的串口（一般带有`CH340`字样的就是了，若没有，可能是驱动安装错误）
5. 点击`下载`即可开始烧录

以上两项烧录完成后，即可通过串口来与开发板进行交互（若你的最后一步为烧写固件，则无需重新插拔板卡，只需要关闭Kflash烧录软件，以解除对串口的占用即可）

打开课程提供的串口读写工具`ss.exe`，它将自动识别目标串口并打开通信窗口，你可以按下开发板串口左侧的按钮（即靠近蓝色LED灯旁的按钮）来重置开发板，这时你应该可以看到如下的输出：

![img](https://hdu-tmp.oss-cn-hangzhou.aliyuncs.com/images/uploads/2023-06-12/flaCmOFs1J.png)



这就说明OS已经被成功烧写到了板卡之中！

## 五、FAQ

1. 我可以使用`ss.exe`之外的串口软件来进行通信吗？

   你完全可以通过其他串口读写软件与之通信，但是由于一些奇怪的原因，某些串口软件无法正常工作（例如putty等）。目前测试可以使用的软件有Windows应用商店中的“串口调试助手”，Github上开源的comtool，还有pyserial自带的miniTerm等。

2. 打开串口后发生报错："panic: sd init fail"（sd XXX）

   你可以尝试按下板卡的重置按钮，或是检查SD卡是否已经完全插入。

3. 我可以不制作/烧录文件镜像，而只烧录固件吗？

   当然可以，不过你可能需要修改代码来避免系统对文件系统检查出错而产生的一系列报错，此外你也无法进行相关文件系统的操作。

4. 为什么我需要将固件以及文件镜像下载到本地？

   因为我们无法在远程平台上为你模拟K210硬件，而它恰好在你的手边。

5. 打开串口后发生报错: "SBI panic XXX"

   请检查你在`make`生成固件前是否进行了`make clean`操作，每次更换平台，请务必进行`make clean`！

6. 进入系统的shell是如何被启动的？

   可以参考实验二中关于用户程序的说明。